name: Main CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # Detect which files changed to decide which tests to run
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      cypress-api: ${{ steps.filter.outputs.cypress-api }}
      cypress-e2e: ${{ steps.filter.outputs.cypress-e2e }}
      playwright: ${{ steps.filter.outputs.playwright }}
      unit: ${{ steps.filter.outputs.unit }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api:
              - 'api-tests/**'
              - 'src/app/api/**'
              - 'prisma/**'
              - 'package.json'
              - 'package-lock.json'
            cypress-api:
              - 'cypress/e2e/api/**'
              - 'cypress/fixtures/api/**'
              - 'cypress/support/commands/apiCommands.js'
              - 'cypress/support/helpers/apiHelpers.js'
              - 'src/app/api/**'
              - 'prisma/**'
              - 'package.json'
              - 'package-lock.json'
              - 'cypress.config.js'
            cypress-e2e:
              - 'cypress/e2e/tests/**'
              - 'cypress/fixtures/*.json'
              - 'cypress/support/commands/commonCommands.js'
              - 'cypress/support/commands/loginCommands.js'
              - 'cypress/support/pages/**'
              - 'src/**'
              - 'prisma/**'
              - 'package.json'
              - 'package-lock.json'
              - 'cypress.config.js'
            playwright:
              - 'e2e/**'
              - 'src/**'
              - 'prisma/**'
              - 'package.json'
              - 'package-lock.json'
              - 'playwright.config.ts'
            unit:
              - 'src/**/*.{test,spec}.{ts,tsx}'
              - 'src/__tests__/**'
              - 'src/lib/**'
              - 'src/app/**/*.tsx'
              - 'vitest.config.ts'
              - 'vitest.setup.ts'
              - 'package.json'
              - 'package-lock.json'

  # Run lint once for all workflows
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.api == 'true' ||
      needs.detect-changes.outputs.cypress-api == 'true' ||
      needs.detect-changes.outputs.cypress-e2e == 'true' ||
      needs.detect-changes.outputs.playwright == 'true' ||
      needs.detect-changes.outputs.unit == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint

  # Run build once for UI tests (Cypress E2E and Playwright E2E)
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [detect-changes, lint]
    if: |
      needs.detect-changes.outputs.cypress-e2e == 'true' ||
      needs.detect-changes.outputs.playwright == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Next.js app
        run: npm run build
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nutriapp_test

  # Unit Tests - runs independently, no database needed
  unit-tests:
    name: Vitest Unit Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, lint]
    if: needs.detect-changes.outputs.unit == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run unit tests
        run: npm run test:run
      
      - name: Generate coverage report
        run: npm run test:coverage
        continue-on-error: true
      
      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results
          path: test-results/
          retention-days: 30
          if-no-files-found: ignore

  # 
  # API Tests - runs independently
  api-tests:
    name: Playwright API Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, lint]
    if: needs.detect-changes.outputs.api == 'true'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: nutriapp_api_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Setup database
        run: |
          npx prisma generate
          npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nutriapp_api_test
      
      - name: Seed database
        run: node --loader ts-node/esm seed.ts
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nutriapp_api_test
      
      - name: Run API tests
        run: npm run test:api
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nutriapp_api_test
          CI: true
      
      - name: Upload API test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-test-report
          path: |
            api-test-results/html-report/
            api-test-results/results.json
          retention-days: 30
          if-no-files-found: ignore

  # Cypress API Tests
  cypress-api-tests:
    name: Cypress API Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, lint]
    if: needs.detect-changes.outputs.cypress-api == 'true'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: nutriapp_cypress_api
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Setup database
        run: |
          npx prisma generate
          npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nutriapp_cypress_api
      
      - name: Seed database
        run: node --loader ts-node/esm seed.ts
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nutriapp_cypress_api
      
      - name: Start Next.js app in background
        run: |
          npx prisma generate
          npm run build
          npm start &
          npx wait-on http://localhost:3000 --timeout 120000
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nutriapp_cypress_api
      
      - name: Run Cypress API tests
        run: npx cypress run --spec 'cypress/e2e/api/**/*.cy.js' --record --group 'API' --ci-build-id ${{ github.sha }}-${{ github.run_number }}
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nutriapp_cypress_api
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload Cypress API screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-api-screenshots
          path: cypress/screenshots
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Upload Cypress API videos
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-api-videos
          path: cypress/videos
          retention-days: 7
          if-no-files-found: ignore

  # Cypress E2E Tests
  cypress-e2e-tests:
    name: Cypress E2E Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.cypress-e2e == 'true'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: nutriapp_cypress_e2e
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Setup database
        run: |
          npx prisma generate
          npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nutriapp_cypress_e2e
      
      - name: Seed database
        run: node --loader ts-node/esm seed.ts
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nutriapp_cypress_e2e
      
      - name: Start Next.js app in background
        run: |
          npx prisma generate
          npm run build
          npm start &
          npx wait-on http://localhost:3000 --timeout 120000
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nutriapp_cypress_e2e
      
      - name: Run Cypress E2E tests
        run: npx cypress run --spec 'cypress/e2e/tests/**/*.cy.js' --record --group 'E2E' --ci-build-id ${{ github.sha }}-${{ github.run_number }}
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nutriapp_cypress_e2e
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload Cypress E2E screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-e2e-screenshots
          path: cypress/screenshots
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Upload Cypress E2E videos
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-e2e-videos
          path: cypress/videos
          retention-days: 7
          if-no-files-found: ignore

  # Playwright E2E Tests
  playwright-tests:
    name: Playwright E2E Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.playwright == 'true'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: nutriapp_playwright
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
      
      - name: Setup fresh database
        run: |
          npx prisma generate
          npx prisma migrate reset --force
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nutriapp_playwright
      
      - name: Seed database
        run: node --loader ts-node/esm seed.ts
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nutriapp_playwright
      
      - name: Build application
        run: npm run build
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nutriapp_playwright
      
      - name: Run Playwright tests
        run: npm run playwright:test
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nutriapp_playwright
      
      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
